<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transformer KV缓存优化原理演示</title>
    <link rel="stylesheet" href="css/transformer.css">
</head>
<body>
    <div class="container">
        <!-- 顶部独立的返回按钮 -->
        <div class="back-button-container">
            <a href="index.html" class="back-button">← 返回</a>
        </div>
        
        <!-- 步骤控制与标题融合在一起 -->
        <div class="step-controls">
            <div class="step-indicator">
                <span>生成token：</span><span id="currentToken">1</span>
                <span>总token数：</span><span id="totalTokens">5</span>
            </div>
            <div class="header">
                <h1>Transformer KV缓存优化原理演示</h1>
            </div>
            <div class="buttons-container">
                <button id="prevStep">上一步</button>
                <button id="nextStep">下一步</button>
            </div>
        </div>

        <!-- 解释区域 -->
        <div class="step-explanation">
            <div class="current-step-info" id="stepInfo">步骤 1/5</div>
            <h3>什么是KV缓存？</h3>
            <p>KV缓存(Key-Value缓存)是一种优化技术，用于减少Transformer模型在自回归生成过程中的计算量。在生成每个新token时，不需要重新计算已生成token的K(Key)和V(Value)矩阵，而是复用之前的计算结果。</p>
        </div>

        <!-- 序列展示 -->
        <div id="sequence-container" class="component-section">
            <h2 class="section-title">Token序列</h2>
            <div class="sequence-display" id="tokenSequence">
                <div class="token" data-token-id="0">我</div>
                <div class="token" data-token-id="1">喜</div>
                <div class="token" data-token-id="2">欢</div>
                <div class="token" data-token-id="3">学</div>
                <div class="token" data-token-id="4">习</div>
            </div>
        </div>

        <!-- KV缓存对比展示 -->
        <div class="grid-layout-2">
            <!-- 左侧：不使用KV缓存 -->
            <div class="component-section">
                <h2 class="section-title">不使用KV缓存</h2>
                <div class="calculation-container">
                    <h3>每次都需重新计算</h3>
                    <div id="without-cache-matrices" class="matrices-grid">
                        <div class="matrix-container">
                            <div class="matrix-group">
                                <div class="matrix-label">Q<span class="matrix-dimensions">(1×d)</span></div>
                                <div id="queryMatrix" class="matrix"></div>
                            </div>
                        </div>
                        <div class="matrix-container">
                            <div class="matrix-group">
                                <div class="matrix-label">K<span class="matrix-dimensions">(t×d)</span></div>
                                <div id="keyMatrixFull" class="matrix"></div>
                            </div>
                        </div>
                        <div class="matrix-container">
                            <div class="matrix-group">
                                <div class="matrix-label">V<span class="matrix-dimensions">(t×d)</span></div>
                                <div id="valueMatrixFull" class="matrix"></div>
                            </div>
                        </div>
                    </div>
                    <div class="calculation-flow">
                        <div class="flow-step">
                            <div id="computationCount" class="process-explanation">计算量: O(t²)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧：使用KV缓存 -->
            <div class="component-section">
                <h2 class="section-title">使用KV缓存</h2>
                <div class="calculation-container">
                    <h3>只计算新token，复用缓存</h3>
                    <div id="with-cache-matrices" class="matrices-grid">
                        <div class="matrix-container">
                            <div class="matrix-group">
                                <div class="matrix-label">Q<span class="matrix-dimensions">(1×d)</span></div>
                                <div id="queryCacheMatrix" class="matrix"></div>
                            </div>
                        </div>
                        <div class="matrix-container">
                            <div class="matrix-group">
                                <div class="matrix-label">K缓存<span class="matrix-dimensions">((t-1)×d)</span></div>
                                <div id="keyCacheMatrix" class="matrix"></div>
                            </div>
                            <div class="matrix-group">
                                <div class="matrix-label">新K<span class="matrix-dimensions">(1×d)</span></div>
                                <div id="keyNewMatrix" class="matrix"></div>
                            </div>
                        </div>
                        <div class="matrix-container">
                            <div class="matrix-group">
                                <div class="matrix-label">V缓存<span class="matrix-dimensions">((t-1)×d)</span></div>
                                <div id="valueCacheMatrix" class="matrix"></div>
                            </div>
                            <div class="matrix-group">
                                <div class="matrix-label">新V<span class="matrix-dimensions">(1×d)</span></div>
                                <div id="valueNewMatrix" class="matrix"></div>
                            </div>
                        </div>
                    </div>
                    <div class="calculation-flow">
                        <div class="flow-step">
                            <div id="computationCountCache" class="process-explanation">计算量: O(t)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 矩阵乘法区域 -->
        <div id="matrix-multiplication-container"></div>
        
        <!-- 注意力矩阵展示 -->
        <div id="attention-matrices-container"></div>

        <!-- 计算效率比较 -->
        <div class="component-section">
            <h2 class="section-title">计算效率比较</h2>
            <div class="formula-result-layout">
                <div class="left-formula">
                    <div class="formula">
                        <h3>不使用KV缓存</h3>
                        <div>每生成一个新token:</div>
                        <div>• 计算t个token的K矩阵</div>
                        <div>• 计算t个token的V矩阵</div>
                        <div>• 计算Q与K的注意力</div>
                        <div>• 计算注意力加权V矩阵</div>
                        <div class="formula-desc">计算复杂度: O(t²)</div>
                    </div>
                </div>
                <div class="right-result">
                    <div class="formula">
                        <h3>使用KV缓存</h3>
                        <div>每生成一个新token:</div>
                        <div>• 只计算新token的K向量</div>
                        <div>• 只计算新token的V向量</div>
                        <div>• 将新K、V添加到缓存</div>
                        <div>• 计算Q与缓存K的注意力</div>
                        <div class="formula-desc">计算复杂度: O(t)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 底部独立的返回按钮 -->
        <div class="footer-back-button">
            <a href="index.html" class="back-button">← 返回</a>
        </div>
    </div>

    <!-- 组件加载脚本 -->
    <script type="module">
        import { loadComponents } from './js/utils/component-loader.js';
        
        // 定义要加载的组件
        const components = [
            { url: './components/matrix-multiplication-section.html', target: '#matrix-multiplication-container' },
            { url: './components/attention-matrices.html', target: '#attention-matrices-container' }
        ];
        
        // 当DOM加载完成后加载组件
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // 加载所有组件
                await loadComponents(components);
                console.log('所有组件加载完成');
                
                // 加载KV缓存控制器
                const { initializeKVCacheDemo } = await import('./js/kv_cache_controller.js');
                initializeKVCacheDemo();
            } catch (error) {
                console.error('组件加载失败:', error);
            }
        });
    </script>
</body>
</html> 